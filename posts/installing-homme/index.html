<!DOCTYPE html>
<html lang="en">
  <head>
    
    
    
    <meta charset="utf-8" />
    <link rel="icon" href="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5-1.ico?v=1630525741731" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Your new 11ty blog" />
    <link rel="stylesheet" type="text/css" href="public/style.css" />
    <link rel="stylesheet" type="text/css" href="public/fonts/cmu.css" />
    <link rel="stylesheet" href="https://unpkg.com/katex@latest/dist/katex.min.css" />
    
    <title>Open Lab Notebook</title>

<meta name="description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta name="robots" content="index,follow">
<meta name="author" content="undefined">

<link rel="canonical" href="https://undefined.glitch.me/posts/installing-homme/">

<meta property="og:title" content="Open Lab Notebook">
<meta property="og:type" content="article">

<meta property="og:url" content="https://undefined.glitch.me/posts/installing-homme/">
<meta property="og:description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta property="og:image" content="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5.png?v=1630525127233">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://undefined.glitch.me/posts/installing-homme/">
<meta name="twitter:title" content="Open Lab Notebook">
<meta name="twitter:description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta name="twitter:image" content="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5.png?v=1630525127233">


  </head>
  <body>
  <main>
    
    
  
    


<div class="wrapper post">
  <div>
    
    <h1 class='postTitle'>Installing HOMME</h1>

    
    
    
    <p>Note: if you're on the greatlakes cluster and its not too long after the date 05/11/21, there
should be a tar.gz file with the dependencies with the correct permissions at <code>/nfs/turbo/cjablono2/owhughes/dependencies.tar.gz</code>.</p>
<p>Ok so after talking to some very talented folks over at the DOE,
I decided that it was time to try to install the Higher Order Method Modeling Environment
(HOMME) on our local cluster computer at U of M.</p>
<p>After some googling I found the following <a href="https://acme-climate.atlassian.net/wiki/spaces/DOC/pages/2735079654/Standalone+HOMME">instructions</a></p>
<p>I'm going to detail here the process of trying to install this.</p>
<h3>Downloading the code:</h3>
<p>Note: follow the instructions for installing dependencies (up to ParallelIO) from <a href="/posts/installing-mpas">this post</a></p>
<p>The E3SM source seems to be available <a href="https://github.com/E3SM-Project/E3SM">here</a>.
<em>Note, you should clone this code rather than rely on any releases.</em>
Run <code>git checkout maint-1.2</code></p>
<p>According to the instructions, I'm going to assume that the working directory should be on
<code>/scratch</code> somewhere.</p>
<p>It appears that some perl modules are necessary, and that <code>cime/scripts/Tools/get_case_env</code> has been renamed to
<code>cime/scripts/Tools/e3sm_check_env</code> which shows that some perl modules need to be installed.</p>
<p>None of the perl modules on greatlakes seem useful, so I do the following:</p>
<ul>
<li>Use the default <code>perl</code> in <code>/usr/bin</code></li>
<li>Add the following to your .bashrc <code>eval &quot;$(perl -I$HOME/perl5/lib/perl5 -Mlocal::lib)&quot;; export PERL5LIB=$HOME/perl5:$PERL5LIB</code></li>
<li>Restart terminal</li>
<li>Run the following to get perl to install locally <code>cpan App::cpanminus</code></li>
<li>Run <code>cpanm LWP</code></li>
<li>The <code>cime/scripts/Tools/e3sm_check_env</code> script has a bug in it: line 54 should read <code>stat = run_cmd('perl -e &quot;require {};&quot;'.format(module_name))[0] </code></li>
<li>To avoid a warning about the git version, you can run <code>module load git/2.20.1</code>.</li>
<li>Then for every module listed in <code>e3sm_check_env</code>, run <code>cpanm {MODULENAME}</code>. You may need to read
error messages to determine what dependencies are, because perl is terrible.</li>
</ul>
<h4>Figuring out which machine file to use:</h4>
<p>The suggested file in the tutorial is <code>mach = $homme/cmake/machineFiles/cori-knl.cmake</code>.</p>
<p>The default centos configuration seems to be promising, so I'm going to use that as my starting point.</p>
<p>The machine file that worked for me was</p>
<pre><code># CMake initial cache file for Linux 64bit RHEL7/CENTOS7
# tested with stock gcc/gfortran and packages from EPEL:
#    openmpi-devel 
#    blas-devel
#    lapack-devel
#    netcdf-fortran-devel
#
#
SET (CMAKE_Fortran_COMPILER mpif90 CACHE FILEPATH &quot;&quot;)
SET (CMAKE_C_COMPILER mpicc CACHE FILEPATH &quot;&quot;)
SET (CMAKE_CXX_COMPILER mpicc CACHE FILEPATH &quot;&quot;)
SET (NetCDF_C $ENV{NETCDF_C} CACHE FILEPATH &quot;&quot;) 
SET (NetCDF_C_LIBRARY $ENV{NETCDF_C}/lib/libnetcdf.so CACHE FILEPATH &quot;&quot;)
SET (NetCDF_C_INCLUDE_DIR $ENV{NETCDF_C}/include CACHE FILEPATH &quot;&quot;)
SET (NetCDF_Fortran $ENV{NETCDF_F} CACHE FILEPATH &quot;&quot;) 
SET (NetCDF_Fortran_LIBRARY $ENV{NETCDF_F}/lib/libnetcdff.so CACHE FILEPATH &quot;&quot;)
SET (NetCDF_Fortran_INCLUDE_DIR $ENV{NETCDF_F}/include CACHE FILEPATH &quot;&quot;)
SET (HDF5_C_LIBRARY $ENV{hdf5}/lib/libhdf5.so CACHE FILEPATH &quot;&quot;)
SET (HDF5_C_INCLUDE_DIR $ENV{hdf5}/include CACHE FILEPATH &quot;&quot;)
SET (HDF5_HL_LIBRARY $ENV{hdf5}/lib/libhdf5_hl.so CACHE FILEPATH &quot;&quot;)
SET (HDF5_HL_INCLUDE_DIR $ENV{hdf5}/include CACHE FILEPATH &quot;&quot;)
SET (PNETCDF_DIR $ENV{PNETCDF} CACHE FILEPATH &quot;&quot;)






SET (WITH_PNETCDF TRUE CACHE FILEPATH &quot;&quot;)

# hack until findnetcdf is updated to look for netcdf.mod
#SET (ADD_Fortran_FLAGS &quot;-I/usr/lib64/gfortran/modules&quot; CACHE STRING &quot;&quot;)

SET (USE_QUEUING FALSE CACHE BOOL &quot;&quot;)
SET (HOMME_FIND_BLASLAPACK TRUE CACHE BOOL &quot;&quot;)


</code></pre>
<p>which is located at <code>mach = $homme/cmake/machineFiles/greatlakes.cmake</code></p>
<p><em>However,</em> this relies on environment variables set in a file I called <code>setup.sh</code> which contains</p>
<pre><code>module load gcc/8.2.0

#module load openmpi/4.0.3
#module load mkl/2021.3.0 
#module load netcdf-c/4.6.2
#module load netcdf-fortran/4.4.5 
#module load python3.6-anaconda/5.2.0 
module load git/2.20.1
export PATH=$scratch/dependencies/mpich/bin:$PATH
export NETCDF_C=$scratch/dependencies/netcdf_c
export NETCDF_F=$scratch/dependencies/netcdf_fortran
export hdf5=$scratch/dependencies/hdf5
export zlib=$scratch/dependencies/zlib
export PNETCDF=$scratch/dependencies/pnetcdf
export FFLAGS=&quot;-L${NETCDF_C}/lib -L$hdf5/lib -L$zlib/lib -L$curld/lib -L$PNETCDF/lib&quot;
export CPPFLAGS=&quot;-I${NETCDF_C}/include -I$hdf5/include -I$zlib/include -I$curld/include -I$PNETCDF/include&quot;
export LDFLAGS=&quot;-L${NETCDF_C}/lib -L$hdf5/lib -L$zlib/lib -L$curld/lib -L$PNETCDF/lib&quot;
export LD_LIBRARY_PATH=&quot;$PNETCDF/lib:${NETCDF_C}/lib:${NETCDF_F}/lib:${hdf5}/lib:${zlib}/lib:${LD_LIBRARY_PATH}&quot;


eval &quot;$(perl -I$HOME/perl5/lib/perl5 -Mlocal::lib):&quot;

export e3sm=&quot;$HOME/HOMME/E3SM&quot;
export homme=&quot;$e3sm/components/homme&quot;
export wdir=&quot;$scratch/HOMME&quot;
export mach=&quot;$homme/cmake/machineFiles/greatlakes.cmake&quot;
</code></pre>
<h4>Compiling</h4>
<ul>
<li>Edit the <code>setup.sh</code> file to point to relevant directories.</li>
<li>Start by running <code>source setup.sh</code> after installing all dependencies following the MPAS installation instructions given <a href="">here</a>.</li>
<li>Run <code>cd $wdir</code></li>
<li>Run <code>cmake -C  $mach $homme</code></li>
<li>In order to check whether compilation works, run <code>make -j4 theta-l</code></li>
</ul>
<h4>Running BW wave with precip:</h4>
<ul>
<li>Run the following:</li>
</ul>
<pre><code>make install
cd dcmip_tests/dcmip2016_test1_baroclinic_wave/
make install
cd theta-l
make install
</code></pre>
<h4>The jobscript for submitting</h4>
<p>I modified the following script for use with slurm on greatlakes.
Each greatlakes node has 36 &quot;cores&quot;, i.e. 18 physical cores with 2 virtual cores after hyperthreading.
I still don't know how to translate between the &quot;PE&quot; numbers in CESM and manual slurm ones (or how to use openmp to its fullest).
This would be worth investigating further, but as it is it appears that this runs in about 2 hours which is shamefully slow for an NE30 run.</p>
<pre><code>#!/bin/bash
#
#SBATCH --job-name d16-1-preqx 
#SBATCH --account=cjablono1
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=36
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=1000m 
#SBATCH --time=0:60:00
#
# 25 nodes, 30min sufficient for all 5 runs
# 12 nodes, 10min for r400 an r100
# 

source /home/owhughes/HOMME/E3SM/setup.sh
export OMP_NUM_THREADS=1
#export OMP_STACKSIZE=16M     #  Cori has 96GB per node. had to lower to 8M on 3K nodes
export MV2_ENABLE_AFFINITY=0
NCPU=36
#if [ -n &quot;$PBS_ENVIRONMENT&quot; ]; then
#  NCPU=$PBS_NNODES
#  [ &quot;$PBS_ENVIRONMENT&quot; = &quot;PBS_BATCH&quot; ] &amp;&amp; cd $PBS_O_WORKDIR 
#  NCPU=$PBS_NNODES
#  let NCPU/=$OMP_NUM_THREADS
#fi
#if [ -n &quot;$SLURM_NNODES&quot; ]; then
#    NCPU=$SLURM_NNODES
#    let NCPU*=16
#    let NCPU/=$OMP_NUM_THREADS
#fi
#let PPN=36/$OMP_NUM_THREADS

# hydrostatic preqx
EXEC=../../../test_execs/theta-l-nlev30/theta-l-nlev30



function run { 
local NCPU=$1
echo &quot;NCPU = $NCPU&quot;
namelist=namelist-$prefix.nl
\cp -f $namelist input.nl
date
mpirun -bind-to=core -np $NCPU $EXEC &lt; input.nl
date

ncl plot-baroclinicwave-init.ncl
ncl plot-lat-lon-TPLSPS.ncl 'var_choice=1'
ncl plot-lat-lon-TPLSPS.ncl 'var_choice=2'
ncl plot-lat-lon-TPLSPS.ncl 'var_choice=3'
\mv -f plot_baroclinicwave_init.pdf  ${prefix}_init.pdf
\mv -f preqx-test16-1latlonT850.pdf  ${prefix}_T850.pdf
\mv -f preqx-test16-1latlonPS.pdf  ${prefix}_PS.pdf
\mv -f preqx-test16-1latlonPRECL.pdf  ${prefix}_PRECL.pdf

\mv -f movies/dcmip2016_test11.nc    movies/${prefix}_dcmip2016_test11.nc
}

prefix=r400    ; run $(($NCPU&gt;384?384:NCPU))

prefix=r100-dry; run $NCPU
prefix=r100-h  ; run $NCPU
prefix=r100    ; run $NCPU

prefix=r50    ; run $NCPU

# high res cases
#prefix=ne120  ; run $NCPU       
#prefix=ne256  ; run $NCPU       
#prefix=ne512  ; run $NCPU       
#prefix=ne1024  ; run $NCPU      

# timings on ANVIL
#ne120  72 nodes, 2h Anvil:  6s
#ne256  72 nodes, 2h Anvil:  55s
#ne512  100 nodes 2h Anvil:  611s (can run on 25 nodes)
#ne1024 100 nodes 2h Anvi:   4642s  (6min init)
#       100 nodes  270 timesteps:  1836s (6min init)
#


</code></pre>
<p>Copy the above into a file located at <code>$wdir/dcmip_tests/dcmip2016_test1_baroclinic_wave/theta-l/jobscript-greatlakes.sh</code></p>
<h4>Reconstructing my method of installing Perl dependencies</h4>
<p>Since I didn't take good enough notes last time I installed stuff I'm going to redo this.</p>
<p>In order to do a fresh install, remove the HOMME directory from scratch and from ~, remove the ~/perl5 directory as well as the ~/.cpan directory.</p>

    <div class="controls">

    
      
          <h3>
            Parent post:
      </h3>
          <ul><li><a href="/open-lab-notebook/posts/installing/">Installing Dycores</a></li></ul>
      
      
      
      
      
    </div>
  </div>
</div>

      <footer class="footer">
        <div class="links">
          <a href="/">Home</a>
          <span class="divider">|</span>
          <a href="/posts">Posts</a>
          <span class="divider">|</span>
          <a href="/about">About</a>
        </div>
        <a class="btn--remix" target="_top" href="https://glitch.com/edit/#!/remix/glitch-hello-eleventy">
        <img src="https://cdn.glitch.com/605e2a51-d45f-4d87-a285-9410ad350515%2FLogo_Color.svg?v=1618199565140" alt="" /> 
        Remix on Glitch
        </a>
        <a class="btn--remix" target="_top" href="https://glitch.com/edit/#!/open-lab-notebook">
        Edit
        </a>
      </footer>
    
  </main>
   
  </body>
</html>
