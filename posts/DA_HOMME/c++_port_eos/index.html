<p>npd---
date: 2023-11-06
tags:</p>
<ul>
<li>posts</li>
<li>misc
eleventyNavigation:
key: compute_pnh_and_exner update
parent: Porting DA HOMME to C++
layout: layouts/post.njk</li>
</ul>
<hr>
<h3>updating compute_pnh_and_exner</h3>
<p>Line 82 in ColumnOps::compute_midpoint_delta(kv,phi_i,exner);
indicates that there is an implementation of the function <code>compute_pnh_and_exner</code> taking <code>phi_i</code> as a parameter
which contains all necessary info to calculate new EOS.
This implementation then calls the <code>compute_pnh_and_exner</code> taking only <code>dphi</code> (hidden in the <code>exner</code> variable).</p>
<ul>
<li>cxx/EquationOfState.hpp:105</li>
<li>cxx/DirkFunctorImpl.hpp:577</li>
</ul>
<h2>DirkFunctorImpl</h2>
<ul>
<li>281: add phi_np1 to method call <code>pnh_and_exner_from_eos</code></li>
<li>322: <code>run_initial_guess</code> contains pattern for computing scans optimally</li>
<li>Currently: just use <code>scan_dphi</code>, which is horribly inefficient</li>
</ul>
<h2>Debugging notes:</h2>
<ul>
<li>When division by rhatinvsq_m is disabled, exner test passes.
<ul>
<li>Three possibilities</li>
<li>phi_i in calling code is different between fortran and c++ (fucked up transpose)</li>
<li>phi_i indexing in calculation of rhatinvsq_m is</li>
<li>phi_i division in compute_pnh_and_exner?</li>
</ul>
</li>
</ul>
<h2>Todo:</h2>
<ul>
<li>Figure out how to access phi_i(ilev+1) and produce correct answer.</li>
</ul>
