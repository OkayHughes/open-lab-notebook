<!DOCTYPE html>
<html lang="en">
  <head>
    
    
    
    <meta charset="utf-8" />
    <link rel="icon" href="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5-1.ico?v=1630525741731" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Your new 11ty blog" />
    <link rel="stylesheet" type="text/css" href="/open-lab-notebook/public/style.css"/>
    <link rel="stylesheet" type="text/css" href="/open-lab-notebook/public/fonts/cmu.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism-twilight.min.css" rel="stylesheet" />
 
    <link rel="stylesheet" href="https://unpkg.com/katex@latest/dist/katex.min.css" />
    
    <title>Open Lab Notebook</title>

<meta name="description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta name="robots" content="index,follow">
<meta name="author" content="undefined">

<link rel="canonical" href="https://undefined.glitch.me/posts/DA_HOMME/StormSPEED_debug/">

<meta property="og:title" content="Open Lab Notebook">
<meta property="og:type" content="article">

<meta property="og:url" content="https://undefined.glitch.me/posts/DA_HOMME/StormSPEED_debug/">
<meta property="og:description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta property="og:image" content="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5.png?v=1630525127233">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://undefined.glitch.me/posts/DA_HOMME/StormSPEED_debug/">
<meta name="twitter:title" content="Open Lab Notebook">
<meta name="twitter:description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta name="twitter:image" content="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5.png?v=1630525127233">


  </head>
  <body>
  <main>
    
    
  
    


<div class="wrapper post">
  <div>
    
    <h1 class='postTitle'>Why is StormSPEED output garbage?</h1>

    
    
    
    <p>Stormspeed output appears to be garbage. Note: the problem is PG specific!
It is present both in interpolated and native output.
In aquaplanet simulations, the edges of the polar panels are clearly present in the output. Inconclusive on whether side panel edges are imprinting in a less visible way.</p>
<p><em>Unifying question: is this problem due to use of explicit new code included in StormSPEED, or due to an interface inconsistency when passing CAM quantities through to HOMME routines?</em></p>
<h2>Promising avenues of exploration:</h2>
<ul>
<li>Examine divergence, gradient, vorticity calculation for test flow field trojan-horsed in via 2016 BW initialization</li>
<li>Prep scatter plot plotting for diagnostics, especially for <code>ncol_d</code></li>
</ul>
<h2>Notes</h2>
<p>Working case is <code>/glade/derecho/scratch/owhughes/StormSPEED_NCAR.ne30pg3_ne30pg3_mg17.QPC7.AQP.is_aqp_garbo/run</code></p>
<h3>Working notes 08/05</h3>
<p>Item number 1: is there a problem?</p>
<ul>
<li>Output GLL quantities</li>
<li>GLL output + NP4 simulations confirm that the problem is with PG2GLL/GLL2PG</li>
</ul>
<p>Next steps:</p>
<ul>
<li>HS test case. Output every time step. Stop after 10 steps. Add constant U/V forcing, See if garbage.</li>
<li>Reduce U amplitude</li>
</ul>
<p>Findings:</p>
<ul>
<li>Zeroed out all forcings in HS except <code><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>U</mi><mo>=</mo><mi>C</mi><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta U = C\cos(\phi)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord">Δ</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span></code>. Initialized with US standard atmosphere</li>
<li>Element columns (but not rows) are visible in GLL output when source of signal is on PG.</li>
<li>Indexing error?</li>
<li>Indexing error also shows up in T!! Note: T forcing is constant everywhere, meaning that this is an indexing error on the metdet/Dinv side of things</li>
</ul>
<h3>Notes 08/06</h3>
<ul>
<li>
<p>Output happens in <code>physics/cam/cam_diagnostics.F90</code></p>
</li>
<li>
<p>Focus on debugging T to focus on this</p>
</li>
<li>
<p>Breadcrumb 1: where is &quot;state%u(:ncol,:)&quot; set?</p>
</li>
<li>
<p>Relevant function calls: <code>dynamics/senh/dp_coupling.F90</code></p>
</li>
<li>
<p>Line 140: <code>gfr_dyn_to_fv_phys</code></p>
</li>
<li>
<p>Line 320: <code>gfr_fv_phys_to_dyn</code> is probably the problem.</p>
</li>
</ul>
<p>Hypothesis: <code>gllfvremap_mod</code> contains the calls that contain the issue.
Idea: trojan horse info into the T field.</p>
<ul>
<li>
<p>Problem appears on boundaries and interior pts of element, so it's likely not DSS issue</p>
</li>
<li>
<p>Testing if <code>gfr_dyn_to_fv_phys_hybrid</code> works</p>
<ul>
<li>We know this is being called, as calling abort near the T remap crashes the run</li>
<li>Does overwriting <code>FT</code> with uniform value of 1 show up in output?</li>
</ul>
</li>
<li>
<p>Setting FT with uniform value still shows grid imprinting (but does change measured value after 1 time step).</p>
</li>
<li>
<p>Does disabling PD coupling entirely solve the problem?</p>
</li>
<li>
<p>In theta, update to T is performed via dt*elem(ie)%derived%FVTheta(:,:,:)</p>
</li>
<li>
<p>Returning to FADIAB vector output:</p>
</li>
<li>
<p>presumptive error is line 550 in <code>interp_mod.F90</code></p>
</li>
<li>
<p>Note: we're not touching <code>interp_mod</code>. Issue is in <code>gfr_fv_phys_to_dyn</code></p>
</li>
<li>
<p>Debugging:</p>
<ul>
<li>overriding uv values in <code>gfr_fv_phys_to_dyn</code> with constant value successfully propagates to output.</li>
<li>Hypothesis: uv indexing is screwed up.</li>
</ul>
</li>
<li>
<p>Wildcard: set metdet to 1 + cos(lat), temperature should show issues?</p>
</li>
<li>
<p>When using scalar routine to remap v, pattern looks correct. Error is specific to <code>gfr_g2f_vector</code>.</p>
</li>
<li>
<p><code>gfr%D_f</code> almost certainly source of problem!</p>
</li>
<li>
<p>Disabling both map to contravariant coords on GLL points and contra-&gt;physical on fv points
results in reasonable looking U, V.</p>
</li>
<li>
<p>Outputting contravariant coords shows element boundaries, as one would expect.</p>
</li>
<li>
<p><code>gfr%D_f</code> lines are exactly the same in stock E3SM HOMME</p>
</li>
<li>
<p>Is <code>grf%D_f</code> just transposed? When transposed, both U and V are screwy.</p>
</li>
<li>
<p>Lower row is wrong. Transposing <code><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mn>2</mn><mo separator="true">,</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">D_{2, 1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></code> <code><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>D</mi><mrow><mn>2</mn><mo separator="true">,</mo><mn>2</mn></mrow></msub></mrow><annotation encoding="application/x-tex">D_{2, 2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></code> does not fix the problem.</p>
</li>
<li>
<p>Question: is <code>gfr%fv_metdet</code> correct? If <code>gfr%D_f</code> is transposed, this would result in identical <code>gfr%fv_metdet</code></p>
</li>
</ul>
<h4>Where is <code>gfr%D_f</code> set?</h4>
<ul>
<li>set in <code>gfr_init_Dmap</code></li>
</ul>
<p>What is going on in these lines?</p>
<pre><code>             k = i + (j-1)*nf
             wrk = wrk*sqrt(gfr%fv_metdet(k,ie)/abs(det))
             det = gfr%fv_metdet(k,ie)

             gfr%D_f(k,:,:,ie) = wrk

             gfr%Dinv_f(k,1,1,ie) =  wrk(2,2)/det
             gfr%Dinv_f(k,1,2,ie) = -wrk(1,2)/det
             gfr%Dinv_f(k,2,1,ie) = -wrk(2,1)/det
             gfr%Dinv_f(k,2,2,ie) =  wrk(1,1)/det
</code></pre>
<ul>
<li>
<p>Using cubed sphere map type 0.</p>
</li>
<li>
<p>We've confirmed that this subroutine is being called.</p>
</li>
<li>
<p>Overwriting <code>D_f</code> lower row with 0 zeros out V. This is correct.</p>
</li>
<li>
<p>Idea: check if cartp points behave as I would expect them to.</p>
</li>
<li>
<p>Observed problem is consistent with <code>b</code> local coordinate being incorrect on equatorial cube faces.
This is because <code><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>D</mi><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mo stretchy="false">(</mo><mi>λ</mi><mo separator="true">,</mo><mi>ϕ</mi><mo stretchy="false">)</mo></mrow><mrow><mi mathvariant="normal">∂</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex"> D = \begin{pmatrix} \cos(\phi) &amp; 0 \\ 0 &amp; 1 \end{pmatrix} \frac{\partial (\lambda, \phi)}{\partial (a, b)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mopen">(</span><span class="mord mathnormal">λ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ϕ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></code> has derivatives with respect to <code>b</code> in the lower row.</p>
</li>
<li>
<p>How is <code>corners</code> calculated?</p>
</li>
</ul>
<p>Hypothesis: are we just seeing lack of commutativity between the remapping operator and transformation to contravariant coordinates? That is, <code>gfr_g2f_remap</code> performs the following:
<code><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold-italic">u</mi><mi>f</mi></msub><mo>=</mo><msup><mi>D</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">x</mi><mi>f</mi></msub><mo stretchy="false">)</mo><mrow><mo fence="true">[</mo><mtext>GllToFv</mtext><mrow><mo fence="true">(</mo><mi>D</mi><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">x</mi><mi>g</mi></msub><mo stretchy="false">)</mo><mi mathvariant="bold-italic">u</mi><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">x</mi><mi>g</mi></msub><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{u}_f = D^{-1}(\boldsymbol{x}_f) \left[ \textrm{GllToFv}\left(D(\boldsymbol{x}_g) \boldsymbol{u}(\boldsymbol{x}_g)  \right) \right]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7305em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">u</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1502em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord text"><span class="mord textrm">GllToFv</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="mord boldsymbol">u</span></span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mclose delimcenter" style="top:0em;">]</span></span></span></span></span></span></code></p>

    <div class="controls">

    
      
          <h3>
            Parent post:
      </h3>
          <ul><li><a href="/open-lab-notebook/posts/DA_HOMME/">Deep Atmosphere HOMME</a></li></ul>
      
      
      
      
      
    </div>
  </div>
</div>


      <footer class="footer">
        <div class="links">
          <a href="/">Home</a>
          <span class="divider">|</span>
          <a href="/posts">Posts</a>
          <span class="divider">|</span>
          <a href="/about">About</a>
        </div>
        <a class="btn--remix" target="_top" href="https://glitch.com/edit/#!/remix/glitch-hello-eleventy">
        <img src="https://cdn.glitch.com/605e2a51-d45f-4d87-a285-9410ad350515%2FLogo_Color.svg?v=1618199565140" alt="" /> 
        Remix on Glitch
        </a>
        <a class="btn--remix" target="_top" href="https://glitch.com/edit/#!/open-lab-notebook">
        Edit
        </a>
      </footer>
    
  </main>
   
  </body>
</html>
