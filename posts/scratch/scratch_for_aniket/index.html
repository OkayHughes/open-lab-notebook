<!DOCTYPE html>
<html lang="en">
  <head>
    
    
    
    <meta charset="utf-8" />
    <link rel="icon" href="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5-1.ico?v=1630525741731" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Your new 11ty blog" />
    <link rel="stylesheet" type="text/css" href="/open-lab-notebook/public/style.css" />
    <link rel="stylesheet" type="text/css" href="/open-lab-notebook/public/fonts/cmu.css" />
    <link rel="stylesheet" href="https://unpkg.com/katex@latest/dist/katex.min.css" />
    
    <title>Open Lab Notebook</title>

<meta name="description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta name="robots" content="index,follow">
<meta name="author" content="undefined">

<link rel="canonical" href="https://undefined.glitch.me/posts/scratch/scratch_for_aniket/">

<meta property="og:title" content="Open Lab Notebook">
<meta property="og:type" content="article">

<meta property="og:url" content="https://undefined.glitch.me/posts/scratch/scratch_for_aniket/">
<meta property="og:description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta property="og:image" content="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5.png?v=1630525127233">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://undefined.glitch.me/posts/scratch/scratch_for_aniket/">
<meta name="twitter:title" content="Open Lab Notebook">
<meta name="twitter:description" content="A blog which serves as my lab notebook, but which is visible to the world because I&apos;m a masochist.">
<meta name="twitter:image" content="https://cdn.glitch.com/8af1b7af-efae-4a35-b1d7-e47b835582bc%2Fall_TMQ_moist_day5.png?v=1630525127233">


  </head>
  <body>
  <main>
    
    
  
    


<div class="wrapper post">
  <div>
    
    <h1 class='postTitle'>Scratch for aniket</h1>

    
    
    
    <p>Using panoply, ensure that you load the <code>openjdk</code> module first. I added the following line
to my <code>~/.bashrc</code> file to simplify running panoply:
<code>alias panoply=&quot;module load openjdk; bash ${HOME}/PanoplyJ/panoply.sh&quot;</code></p>
<p>Note that I downloaded the <code>PanoplyJ</code> to the <code>${HOME}</code> folder.</p>
<p>My recommendation is to look in the <code>/scratch/cjablono_root/cjablono0/daniket/</code>, which is your scratch directory
and find the <code>.nc</code> (NetCDF) file generated by our previous model run. Do this in bash first so you know where it is.
Now run panoply and open that <code>.nc</code> file.</p>
<p>At this point you can start generating plots. My first recommendation would be to look at the <code>PS</code> field (which is surface pressure).
Create latitude-longitude plots for different temporal snapshots. This will show the evolution of the wave.
The fields <code>U</code> and <code>V</code> contain, respectively, zonal (east-west) and meridional (north-south) wind. Note that these variables have
an extra dimension compared to <code>PS</code>, which is <code>lev</code>. This is the vertical level. Surface pressure is only defined at the surface.
How does the <code>U</code> field differ from the <code>PS</code> and <code>V</code> fields at the first time snapshot? Does the time evolution of PS and V
exhibit similarities?</p>
<p>Probably the most interesting field for this simulation is the temperature field, <code>T</code>, given in units of Kelvin.
What do you notice about the initial distribution of temperature? How does it change at different levels of the model within the first time snapshot?
How does the time-evolution of <code>T</code> mirror and how does it differ from the evolution of <code>U</code> and <code>V</code>. Given that <code>V</code> represents wind,
think about e.g. walking past the door to an air-conditioned building on a hot day when the door opens. Wind coming from inside the building
transports cool air from inside to where you are on the outside. How does that relate to what we're seeing in the <code>T</code> field?</p>
<h2>Modifying the source code</h2>
<p>Since you already have a case directory, I'll assume that you have the location stored in
a variable called <code>$CASE_DIR</code>. The contents of this directory should look like:
<img class="center large" src="https://open-lab-notebook-assets.glitch.me/assets/aniket/source_mods_tutorial/case_directory.png">
and if you lost it and want to find it again (or, more specifically, find all case directories
contained in your home directory) then you can run <code>find ~ -name &quot;SourceMods&quot;</code>.</p>
<p>We will work from within the case directory, so run <code>cd ${CASE_DIR}</code>.
The way that source code modifications work in CAM is that if you take a fortran source file
(these end in the suffix <code>.f90</code> or <code>.f</code>) and copy it to <code>${CASE_DIR}/SourceMods/src.cam/</code> and
run <code>./case.build</code> to rebuild the case, then any modifications made to the source file
will be included in the executable for your case.</p>
<p>We'll work with the concrete example of the source file <code>ic_baro_dry_jw06.F90</code>
which defines the initial conditions for the test case that we're running.</p>
<p>To find the location of the original file, you can run <code>find ~ -name &quot;ic_baro_dry_jw06.F90&quot;</code></p>
<p>From within your case directory you should run <code>cp ${PATH_TO_IC_BARO_DRY}/ic_baro_dry_jw06.F90 SourceMods/src.cam</code>.
Using your text editor of choice (<code>nano</code> and <code>vim</code> are simple choices, but <code>vim</code>
has a few early stumbling blocks) to edit the copied file.
For me that reads as <code>vim SourceMods/src.cam/ic_baro_dry_jw06.F90.</code></p>
<p>The crucial parameters that define the test case are found in this file,
in the section of the code that looks like
<img class="center large" src="https://open-lab-notebook-assets.glitch.me/assets/aniket/source_mods_tutorial/test_case_params.png">
The description of the structure of this test case can be found in the <a href="https://opensky.ucar.edu/islandora/object/technotes%3A481">following paper</a>.</p>
<p>A good introductory exercise for learning how to change CAM source code is changing these parameters
and seeing how this impacts the resulting model output.</p>
<p>A good starting parameter to change is <code>perturbation_amplitude</code> which is the
strength of the nudge that starts the wave in motion.
To see how this works, we'll start by running two simulations.
An important caveat is that if you are running a particular case (which is a particular
configuration of the CAM model) that lives in <code>$CASE_DIR</code> multiple times, the output NetCDF
file will be overwritten.</p>
<p>Keeping this in mind, I lay before you the following challenge:</p>
<ol>
<li>Copy the fortran file to the <code>SourceMods/src.cam</code> directory and build the model using <code>./case.build</code>.</li>
<li>Run the model with the default value of <code>perturbation_amplitude</code> set in the <code>SourceMods/src.cam/ic_baro_dry_jw06.F90</code>, i.e. run <code>./case.submit</code>.
Note: you can check the status of running jobs with <code>squeue -u ${USER}</code>. Once your job completes, continue to the next step.</li>
<li>Find the output NetCDF file. The right-most directory in <code>${CASE_DIR}</code> (in my setup this is <code>CAM_JUNE22.ne30_ne30_mg17.FADIAB.36.test_cases.jw06</code>)
is the name of your case. Since your scratch directory is located at <code>/scratch/cjablono_root/cjablono0/daniket/</code>
try to find a directory that has the same case name as what we found in <code>${CASE_DIR}</code>.</li>
<li>Navigate to this directory, which should contain two subdirectories, <code>bld</code>, and <code>run</code>. Navigate into the <code>run</code> subdirectory.</li>
<li>If all has gone to plan, there should be a file with the <code>.nc</code> suffix, which you can find by doing <code>ls *.nc</code>.</li>
<li>Rename this NetCDF file to something like <code>default_perturbation_amplitude.nc</code></li>
<li>Go back to your case directory. Modify <code>SourceMods/src.cam/ic_baro_dry_jw06.F90</code> to double the strength of the perturbation.</li>
<li>Run <code>./case.build</code> and if this completes successfully run <code>./case.submit</code>. Wait for the job to complete.</li>
<li>Navigate to the output directory and rename the NetCDF file to something like <code>doubled_perturbation_amplitude.nc</code>.</li>
<li>A little exercise to test your retention: Determine the steps you need to do to
run the model with <code>perturbation_amplitude</code> set to 0. Rename the NetCDF file to something like
<code>nil_perturbation_amplitude.nc</code>.</li>
</ol>
<p>After you're done, you should have an output directory that contains three NetCDF files: one where the model was run with
a default perturbation amplitude, one where the perturbation amplitude is doubled, and one where
the perturbation is not present. Use panoply to explore these output files and try to figure out what changed.
Is there a pattern? Try to see if you can see why; if you're interested in thinking deeply about this, you should look at the paper I linked above which covers the details of this
test case in gory detail.</p>
<p>Keep me posted!!</p>
<p>If you get through this wicked fast and are interested in doing something else, my next suggestion
is to break the test case in a major way. I won't tell you how to do it, surprise me. Make sure it's not so
broken that the model doesn't run. Explain what you did.</p>

    <div class="controls">

    
      
          <h3>
            Parent post:
      </h3>
          <ul><li><a href="/open-lab-notebook/posts/scratch/">scratch</a></li></ul>
      
      
      
      
      
    </div>
  </div>
</div>

      <footer class="footer">
        <div class="links">
          <a href="/">Home</a>
          <span class="divider">|</span>
          <a href="/posts">Posts</a>
          <span class="divider">|</span>
          <a href="/about">About</a>
        </div>
        <a class="btn--remix" target="_top" href="https://glitch.com/edit/#!/remix/glitch-hello-eleventy">
        <img src="https://cdn.glitch.com/605e2a51-d45f-4d87-a285-9410ad350515%2FLogo_Color.svg?v=1618199565140" alt="" /> 
        Remix on Glitch
        </a>
        <a class="btn--remix" target="_top" href="https://glitch.com/edit/#!/open-lab-notebook">
        Edit
        </a>
      </footer>
    
  </main>
   
  </body>
</html>
